---
title: "30. User generated client API keys"
date: 2024-02-22T15:30:00+01:00
weight: 30
geekdocRepo: https://github.com/owncloud/ocis
geekdocEditPath: edit/master/docs/ocis/adr
geekdocFilePath: 0030-user-generated-client-api-keys.md
---

* Status: draft
* Deciders: [@butonic](https://github.com/butonic), [@fschade](https://github.com/fschade), [@kulmann](https://github.com/kulmann), [@dragotin](https://github.com/dragotin), [@rhafer](https://github.com/rhafer)
* Date: 2024-02-22

## Context and Problem Statement

Currently, the oCIS proxy is used to authenticate users based on an OpenID Connect access token or using basic auth.
The current implementation is limited to a single identity provider, and we currently have no way to generate credentials for cli tools that do not yet support OpenID Connect.

The coming up calendar and contacts service (ccs) requires this because most CalDAV and CardDAV clients require basic or digest authentication.
Also any service which is based around the concept of impersonation would require the capability to such credentials.

## Decision Drivers <!-- optional -->

## Considered Options

* oCIS proxy middleware with micro store

## Decision Outcome

Chosen option: *???*

### Positive Consequences:

* TODO

### Negative Consequences:

* TODO

## Pros and Cons of the Options <!-- optional -->

### oCIS proxy middleware with micro store

We use a micro store implementation to save generated access keys.
Generated access keys will have a scope attached to limit access to oCIS services or endpoints.

Definition of scopes is out of scope for this ADR.

The generated access keys need to be entered into classic authentication forms which consist of user and password.
Both elements need to be provided/generated by oCIS to the user.

There will be a web frontend where users can:
- create a new pair of user and password(key) for selected scopes and give some display name
- newly generated password will be show only once upon creation
- list existing keys with display name, scope, user, but not the password
- delete a key from the list

An oCIS proxy authentication middleware will evaluate http authentication headers with schema basic and look up if the request is valid.

#### Key generation
The key id is an uuid. It will be used as ID in basic auth.
Upon creation of the key id the key secret will be created by computing the signature of the key id using HS256 signing method and a private signing key.

Scopes and oCIS user id will be stored in micro store implementation using the generated key id as identifier.

Example:
User `einstein` is requesting credentials which might look like:
key id: `fffe72b7-e076-4bf7-a4c8-bf23915dba4e`
key secret: `D6gbcRzyVor0C9damdh_MxrFaoz006XTzE8LQNAFTIQ`

(Note: secret is generated using `lorem` as signature key)


### Authentication
Key id and key secret will be read from the http authentication header.
The signature will be computed from the key id using the hs256 method and the private key.
The computed signature will be compared to the key secret from the authentication header.
If the signatures do not match we can deny access without hitting any storage which limits the DOS capabilities.
If the signatures match:
- read scope and oCIS user data from micro store
- validate user to be enabled and still existing
- validate scope
- grant access if applicable

- Good, the middleware can differentiate basic auth for user generated client API keys from username:password authentication without making an RPC and additional network latency.
- Good, invented by us :dancers:
- Bad, ???



## Links <!-- optional -->
